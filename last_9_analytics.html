<!DOCTYPE html>
<html>
<!--
      To Do:
          1) Stylize with CSS
          2) If the first post grabbed was made only a few minutes ago then its comments and likes will be low and will skew your numbers.
             Look into a way to drop the first post if its less than x hours old
          3) Submit button can only be pressed once per refresh. Otherwise it keeps adding to the list. Find a way to clear the list or grey out the button
          4) Find a way to store results so you can compare over time
          5) 1000 milisecond time delay is kinda hacky, there should be a better way
          6) No. of Followers should have a comma in the numbers to make it easier to read
          7) Submit to github once the CSS looks agreeable
          8) Clean up var usernameToken, it should only appear once
-->
  <head>
    <meta charset="utf-8">
    <title>9 Images Analytics</title>
    <style>
      /*
      .demo {
        border: 1px solid #C0C0C0;
        border-collapse: collapse;
        padding: 5px;
      }
      .demo th {
        border: 1px solid #C0C0C0;
        padding: 5px;
        background: #F0F0F0;
        margin: 0 auto;
      }
      .demo td {
        border: 1px solid #C0C0C0;
        padding: 5px;
      }
      */
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript">

      function ajax() {
        // First Ajax, Gets the profile pic, the user id #, and the username
        var username = document.getElementById("username").value;
        var usernameToken = "&access_token=2806374073.1677ed0.c9383b1f609d4c0990adad916ba0502d";
        $.ajax({
          type: "GET",
          dataType: "jsonp",
          username: username,
          cache: false,
          url: "https://api.instagram.com/v1/users/search?q=" + username + usernameToken,
          success: function(data) {
            for (var i = 0; i < data.data.length; i++) {
              if (this.username == data.data[i].username) {
                //Display the User's ID
                $("#result .user_id").append("User ID: " + data.data[i].id + "<br />");
                //Display your profile pic so you know with certainty that this is the profile you searched for
                var avatar = "<a href='" + data.data[i].profile_picture + "' class='thumbnail' target='_blank'><img src='" + data.data[i].profile_picture + "' alt=''></a>";
                $("#result .avatar").append(avatar);
                //Display the username
                var username = "Username: " + data.data[i].username + "<br />";
                $("#result .text").append(username);
                //Second request
                //Adds the Likes+Comments data to the rows
                $.ajax({
                  type: "GET",
                  dataType: "jsonp",
                  url: "https://api.instagram.com/v1/users/" + data.data[i].id + "/media/recent/?access_token=2806374073.1677ed0.c9383b1f609d4c0990adad916ba0502d",
                  success: function(data) {
                    var tr;
                    for (var i = 0; i < 9; i++) {
                      tr = $('<tr/>');
                      tr.append('<td class="comment_count">' + data.data[i].comments.count + '</td>');
                      tr.append('<td class="likes_count">' + data.data[i].likes.count + '</td>');
                      $('#myTable').append(tr);
                    }
                  }
                });
                //Third request
                //Adds the followers count
                $.ajax({
                  type: "GET",
                  dataType: "jsonp",
                  url: "https://api.instagram.com/v1/users/" + data.data[i].id + "/?access_token=2806374073.1677ed0.c9383b1f609d4c0990adad916ba0502d",
                  success: function(data) {
                    //Add the # of followers
                    var followers = "# of Followers: " + data.data.counts.followed_by + "<br />";
                    $("#result .followers").append(followers);
                  }
                });
              }
            }
          }
        });
        //This is where I add up all the numbers in the Comments and Likes columns
        //setTimeout for a deley in processing. Helps Ajax not fuck up
        setTimeout(function() {
          var sum = 0;
          //Get comment count numbers
          $(".comment_count").each(function() {
            var value = $(this).text();
            // add only if the value is number
            if (!isNaN(value) && value.length != 0) {
              sum += parseFloat(value);
            }
          });
          var tot = 0;
          //get likes count numbers
          $(".likes_count").each(function() {
            var value_likes = $(this).text();
            if (!isNaN(value_likes) && value_likes.length != 0) {
              tot += parseFloat(value_likes);
            }
          });
          $('.totalComment').text("Total: " + sum);
          //Below takes the total number of likes and displays that number, then on the next line it divides the number by 9 and displays the average likes
          $('.totalLikes').html("Total: " + tot + "<p>Avg: " + parseInt(tot / 9) + "</p>");
          //Add in the math for the engagement Ratio
          //[Likes + Comments] / Followers = Engagement Rate
          //I only sample the first 9 images on their account. No sense in getting numbers for pics that are 6 months old
          var likesAndComments = tot + sum;
          var numOfFollowers = $(".followers").text().split(": ").pop();
          var engagementRatio = likesAndComments / numOfFollowers * 100;
          $("#sum_table").append("Engagement Ratio: " +
            "<b>" + engagementRatio.toFixed(2) + "</b>");
        }, 1000);
        //delay 1000 ms
      }
    </script>

  </head>
  <body>

    <!--Get user ID from username -->
    <p>
      Put username here
    </p>
    <input type="text" id="username" name="username" value="">
    <input type="button" value="submit" onclick="ajax()" id="get_id">
    <div id="result">
      <div class="avatar"></div>
      <div class="text"></div>
      <div class="followers"></div>
      <div class="user_id"></div>
    </div>

    <table id="myTable" cellpadding="2" cellspacing="2" border="1">
      <thead>
        <tr>
          <th>Comments</th>
          <th>Likes</th>

        </tr>
      </thead>
    </table>

    <table id="sum_table" width="131" border="1">
      <tr class="totalColumn">
        <td class="totalComment">Total:</td>
        <td class="totalLikes">Total:</td>
      </tr>
    </table>

  </body>
</html>
